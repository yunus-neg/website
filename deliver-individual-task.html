<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Language" content="ar" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" type="text/css" href="hanadi.css" />
  <link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAS5SURBVGhD7VhbT1xVFEYfjA8an0xM1MQ/4Ksm+sBD58acw8DA3jNcLMzItOWSthJMiwIFWrAYi1qTqrUxwXgjFkNbW6SWak1Te1GkUIECLdOBKaXlDgWsNS7XnrPPmTNwhtBxmCHmfMkXCPuctb5vr7332pwEHTp06NChQ4eO/zESKX3MIBCbUSTlRpF+YBRII/7+iUkku02iI9ViIU/yR9cnjMmOl1HwcRT/p0mksALvo6kTRjHdxF9dHzClOJ9lwtRizckO8BQUw443q6Gsci+U7NwF7s1bA39XP2cSyGlzivM5Hip+YLOKVbgjC9tcVAItrafh9u0JWFy8r3Byag6Ghkeg9+oAfPFVE7y6ZbtiBt+fYUuRh4w9AvtAIH8zMXaHC062/QwLC3+FGFBzfv4ejI6Ogc/nhxs3huHLxiawkY2yIbbcnDx07GC0pr9oFOg8E5GX/xp4vTc1xWtxfHw6YIbx4qUOyHbnS5URyD2TNf0lnmLtkZiY+yguh2ss+SvuAvD7RzUFr8QpXGqymY6OLnBu3MQrQ/w2m+1xnmptgTNXw5ImpWRAT+91TaGrodrMqbYzykFgtJKDZoFWYZ4jJoGeMVnJYZZTEHKe5hL+O9hs4azdZQkPHGzQFPggHBubUsyUVtTwqoQnGhqxCE7K5UQOg0g8LKA1NXPZyRQpR0buwMeHPgOLzRki2mxzgGDPBMvSI5uNifQCpfQRLuvBgTPyAwtUVbNPU1QkrN//kSLQ7siFPW/VQ3dPf2BsYmImUK1z53+Dsl21S0yRWxGbkXtG87HWZYIiZba7MCCsvGovCp9dNj41fVdZft29/ZCZu0UxY0yml7m01UPq4FKAy509yxJGyqt9Xmj78eyKPUi9l7zeIchyFShmNoikkEsMj8rKyoexhG6sxEV8CZuW9HKqIwdq394Pff1ezcTRJjM57L+lmOnruw5JtgxuhsxwudqwWulTeBc6L4vXojU1AxoPH9VMHm2qGyljTd27QR3hGqnBQJ/Ajd0tP/h6aRV8f/InuPJHH/za3gUNn38DjmyPEuiXC+2ayaPJubnFECOdXT3s9JI0WOnXXHoosBEdYg+wJtXU3KIZmM0Qu9nSLA/0D/g0n4k21UYYBXtWwAhO+iUuPQiLxf4MDgQug9FoetEku0GrjaRluKSKCOQalx8EbuxCNiimZQVOC62A8aLaBGO2SzqKceIbufwg0MiHbHBbSZlmsHhx6R4ZGBgEUV5aIi3m8oPA46yBDZaW79EMGC/KXV7mt83HpWWF3JBEnufyg8CK1LHBnLwizYDxIvt3QTbBmqJr01ZuhPRw6aHAa7NFdtr++xXNoLHm5ORsSDX2vXdAqQbuD8Klh4JdxHDQyx7Ky98O4xPTmsFjxdnZBRgauqlUov794CUTT6tjKPkhSbkG0IgdH/xHNhOvykxPz4MPTQwO+uDod63gyS9WVYJ2ssbNJYcHmnlDNsOY4ykKNMDq2vo1Z1XNO1BRXQc7y3ZDwbYd6o8UEgXasioTMtAMxfL5QoLEkwIZNCTTTHaZ5RJXD/axwWxNT5M+f9IjeKqdihXxRDqBPz/FvBVo4gWUE34/6NChQ4cOHTp0rFckJPwL4qQcu4ZL4ykAAAAASUVORK5CYII=" />
  <title>أنظمة غيمة - Cloud Systems - إضافة مهمّة فرديّة</title>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script type="text/javascript" src="js/common.js"></script>

  <script
    src="https://code.jquery.com/jquery-1.8.3.min.js"
    integrity="sha256-YcbK69I5IXQftf/mYD8WY0/KmEDCv1asggHpJk1trM8="
    crossorigin="anonymous"></script>
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56731261-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-56731261-3');
  </script>
</head>
<body>
  <nav id="error-message" class="error">
    Something went wrong!
  </nav>
  <nav>
    <ul>
      <li>
        <a href="index.html">الرئيسيّة</a>
      </li>
      <li id="user-email"></li>
    </ul>
  </nav>
  <div class="container">
    <div class="logo">
      <a href="index.html">
        <img src="http://techlify.com/sites/default/files/2017-07/cloud-computing.png" width="55px">
      </a>
    </div>
    <div class="breif">
      <strong>تسليم إجابة مهمّة:</strong> يُمكن للمتدرّب أن يسلّم إجابته لمهمّةٍ ما بعد تسجيل الدخول ببريده الإلكتروني والتأكّد من كون المهمّة قد أسندت إليه. يجب ألاّ يتأخّر المتدرّب في التسليم ويتخطّى أقصى وقت للتسليم، كما يجب اتّباع التعليمات لكلّ حقلٍ بشكلٍ دقيق.
    </div>
    <div class="form-container">
      <form id="form">
        <div id="preview-mode" class="preview-container">
          <div class="subject">
            الإجابات (مُعاينة)
          </div>
          <div class="content">
            <span id="answers-preview">answers</span>
          </div>
        </div>
        <div id="edit-mode">
          <div id="jsGrid"></div>
        <!--
        <div class="form-input">
          <label for="answers">الإجابات (مطلوب)</label>
          <p>تأكّد من أن تبدأ كلّ إجابة في سطر جديد بعد علامة الناقص "-"، ثم مسافة ثم عبارات تصف بها الإجابة ثم مسافة ثم بين قوسين ضع رابط الإجابة ثم نقطة لإنهاء الإجابة وهكذا مع بقيّة الإجابات. الرابط لكل إجابة قد يكون رابط فيديو في Youtube، أو رابط ملف مُستندات Google، أو غيرها. المهم في الرابط أن يكون يُمكن الوصول إليه من قِبل المُرشدين، وإلاّ فسيتم اعتبار الإجابة غير صحيحية.</p>
          <textarea id="answers" placeholder="- الإجابة 1 (URL1)." required></textarea>
        </div>
        -->
        </div>
        <div class="form-buttons">
          <button id="preview" class="submit">عاين الإجابة</button>
          <input type="submit" id="submit" class="submit" value="أرسِل الإجابة" />
          <button id="edit" class="secondary">عدِّل الإجابة</button>
        </div>
      </form>
    </div>
    <div class="copyrights">
      (ح) جميع الحقوق محفوظة لمؤسّسة أنظمة غيمة (Cloud Systems).
    </div>
  </div>
  <script type="text/javascript">

  // redirectToProfileIfNotLoggedIn();
  checkIfLoginOrNot();

  function checkIfLoginOrNot() {
    var accessToken = Cookies.get('accessToken');
    if (!accessToken) {
      return redirectToLogin();
    } else {
      $.ajax('https://d2hbxkrooc.execute-api.eu-west-1.amazonaws.com/dev/auth/trainees', {
        headers: {
          'Authorization': 'Bearer ' + accessToken,
        },
        success: function(data) {
          console.log('success', data);
          updateLoginBox();
        },
        error: function(data) {
          return redirectToLogin();
        }
      });
    }
  }

  function redirectToLogin() {
    Cookies.remove('accessToken');
    Cookies.remove('email');
    Cookies.set('redirectUri', window.location.href);
    window.location.href = 'profile.html';
  }

  var userAnswers = [];
  var answers = '';

  $(function() {
    $('#jsGrid').jsGrid({
      width: '100%',
      height: '300px',
      inserting: true,
      editing: true,
      sorting: true,
      paging: true,

      data: userAnswers,
      confirmDeleting: false,
      noDataContent: 'لم يتم إضافة إجابات حتّى الآن.',

      fields: [
        { name: 'عنوان الإجابة', type: 'text', validate: 'required' },
        { name: 'رابط الإجابة (URL)', type: 'text', validate: 'required' },
        { type: 'control' },
      ]
    });
  });

    function updateLoginBox() {
      var userEmail = document.getElementById('user-email');
      var cookiesEmail = Cookies.get('email');
      if (cookiesEmail) {
        userEmail.innerHTML = '<a href="profile.html">' + cookiesEmail + '</a>';
      }
    }

    // Define some variables.
    var accessToken = Cookies.get('accessToken');
    var id = getQueryString('id');
    var errorMessage = document.getElementById('error-message');
    var form = document.getElementById('form');
    var preview = document.getElementById('preview');
    var edit = document.getElementById('edit');
    var submit = document.getElementById('submit');

    // Modes.
    var editMode = document.getElementById('edit-mode');
    var previewMode = document.getElementById('preview-mode');

    // Preview.
    var answersPreview = document.getElementById('answers-preview');

    // Hide the error message initially.
    errorMessage.style.display = 'none';
    previewMode.style.display = 'none';
    submit.style.display = 'none';
    edit.style.display = 'none';

    function parseAnswers(answers) {
      var list = [];
      for (var i=0; i<answers.length; i++) {
        list.push({
          title: answers[i]['عنوان الإجابة'],
          url: answers[i]['رابط الإجابة (URL)'],
        });
      }
      return list;
    }

    // Define variables to be used to send a request.
    var http = new XMLHttpRequest();
    var url = 'https://d2hbxkrooc.execute-api.eu-west-1.amazonaws.com/dev/individual-tasks/deliver';

    http.onreadystatechange = function() {
      if (http.readyState == XMLHttpRequest.DONE) {
        submit.disabled = false;
        if (http.status == 204) {
          return window.location.href = 'thank-you-for-delivering-task.html';
        }
        errorMessage.style.display = 'block';
        edit.style.display = 'inline-block';
        if (http.status == 400) {
          errorMessage.innerHTML = 'الرجاء التأكّد من تعبئة الحقول المطلوبة ومن دخول رابط صحيح.';
        }
        if (http.status == 401) {
          errorMessage.innerHTML = 'لا يُمكنك الوصول إلى هذه الصفحة.';
        }
        if (http.status == 409) {
          errorMessage.innerHTML = 'لقد قمت بتسليم الإجابة مُسبقًا.';
        }
        if (http.status == 403) {
          errorMessage.innerHTML = 'لا يُمكن إرسال الإجابة لكون المهمّة لم تُسند إليك.';
        }
        if (http.status == 408) {
          errorMessage.innerHTML = 'انتهت فترة تسليم الإجابة.';
        }
        if (http.status == 410) {
          errorMessage.innerHTML = 'حدث خطأ ما، الرجاء المحاولة لاحقًا.';
        }
      }
    }

    var handlePreview = function(event) {
      if (form.checkValidity() == false) return;
      event.preventDefault();
      editMode.style.display = 'none';
      previewMode.style.display = 'block';
      preview.style.display = 'none';
      submit.style.display = 'inline-block';
      edit.style.display = 'inline-block';

      var parsedAnswers = parseAnswers(userAnswers);
      var answersPreviewHTML = '';

      if (parsedAnswers.length == 0) {
        answersPreviewHTML = '(خطأ في صياغة الإجابات، الرجاء التعديل وفق التعليمات).<br />';
        submit.style.display = 'none';
      } else {
        submit.style.display = 'inline-block';
      }

      answers = '';

      for (var i = 0; i < parsedAnswers.length; i++) {
        answersPreviewHTML += '- ' + parsedAnswers[i].title + ' (<a href="#">' + parsedAnswers[i].url + '</a>).<br />';
        answers += '- ' + parsedAnswers[i].title + ' (' + parsedAnswers[i].url + ').\n';
      }
      answersPreviewHTML += '<br />';
      answersPreview.innerHTML = answersPreviewHTML;
    }

    var handleEdit = function(event) {
      event.preventDefault();
      editMode.style.display = 'block';
      previewMode.style.display = 'none';
      preview.style.display = 'inline-block';
      submit.style.display = 'none';
      edit.style.display = 'none';
    }

    var handleSubmit = function(event) {
      event.preventDefault();
      edit.style.display = 'none';
      submit.disabled = true;
      errorMessage.style.display = 'none';

      http.open('POST', url, true);

      // Set some headers.
      http.setRequestHeader('Content-type', 'application/json');
      http.setRequestHeader('Accept', 'application/json');
      http.setRequestHeader('Authorization', 'Bearer ' + accessToken);

      // Make a new request.
      var params = JSON.stringify({
        'id': id,
        'answers': answers,
      });

      http.send(params);
    }

    // Start dealing with them.
    form.addEventListener('submit', handleSubmit, false);
    preview.addEventListener('click', handlePreview, false);
    edit.addEventListener('click', handleEdit, false);

  </script>
</body>
</html>